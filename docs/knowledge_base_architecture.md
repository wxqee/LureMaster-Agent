# 知识库架构设计与维护说明

## 一、架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        知识库系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ 知识采集层   │    │ 知识管理层   │    │ 知识应用层   │        │
│  ├─────────────┤    ├─────────────┤    ├─────────────┤        │
│  │ • 网页采集   │───▶│ • 元数据管理 │───▶│ • 向量检索   │        │
│  │ • 手动录入   │    │ • 版本控制   │    │ • 关键词搜索 │        │
│  │ • LLM 生成  │    │ • 质量评估   │    │ • 智能推荐   │        │
│  │ • 用户反馈   │    │ • 备份恢复   │    │ • 知识融合   │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│         │                  │                  │                │
│         ▼                  ▼                  ▼                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    数据存储层                            │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  fishing_knowledge.json  │  knowledge_versions.json     │   │
│  │  (主知识库)              │  (版本历史)                  │   │
│  │  vector_index.json       │  backups/                    │   │
│  │  (向量索引)              │  (备份目录)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 二、核心模块

### 2.1 知识管理器 (KnowledgeManager)

**职责**：知识的完整生命周期管理

**核心功能**：
- 知识添加与更新（带元数据）
- 版本控制
- 反馈收集
- 知识验证
- 统计分析

**代码位置**：[skills/knowledge_manager.py](skills/knowledge_manager.py)

### 2.2 向量存储 (VectorStore)

**职责**：语义检索与智能搜索

**核心功能**：
- 向量索引构建
- 语义搜索
- 混合检索（语义 + 关键词）
- 相似度计算

**代码位置**：[skills/vector_store.py](skills/vector_store.py)

### 2.3 知识生成器 (KnowledgeGenerator)

**职责**：LLM 驱动的知识生成

**核心功能**：
- 鱼种知识生成
- 路亚饵知识生成
- 钓组知识生成
- 知识格式化输出

**代码位置**：[skills/knowledge_generator.py](skills/knowledge_generator.py)

## 三、数据结构

### 3.1 知识条目结构

```json
{
  "name": "青鱼",
  "aliases": ["草鱼", "黑鲩", "青鲩"],
  "habits": "青鱼主要栖息在中下层水域...",
  "best_season": ["春末", "夏季", "秋季"],
  "best_time": ["清晨", "傍晚"],
  "lures": ["软虫饵", "波爬饵", "亮片"],
  "techniques": ["慢速拖拽", "定点抛投"],
  "water_layer": "中下层",
  "difficulty": "中等",
  "tips": "青鱼对水质要求较高...",
  "_meta": {
    "version": 1,
    "created_at": "2026-02-13T10:30:00",
    "updated_at": "2026-02-13T10:30:00",
    "source": "llm_generated",
    "confidence": 0.6,
    "verified": false,
    "verified_by": null,
    "verified_at": null,
    "feedback_count": 0,
    "positive_feedback": 0,
    "negative_feedback": 0,
    "status": "active",
    "parent_version": null,
    "tags": []
  }
}
```

### 3.2 元数据字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| version | int | 版本号，每次更新递增 |
| created_at | str | 创建时间 (ISO 8601) |
| updated_at | str | 最后更新时间 |
| source | str | 知识来源 |
| confidence | float | 置信度 (0.0-1.0) |
| verified | bool | 是否已验证 |
| verified_by | str | 验证者 |
| feedback_count | int | 反馈总数 |
| positive_feedback | int | 正面反馈数 |
| negative_feedback | int | 负面反馈数 |
| status | str | 知识状态 |
| tags | list | 标签列表 |

### 3.3 知识来源与置信度

| 来源 | 默认置信度 | 说明 |
|------|-----------|------|
| expert | 1.0 | 专家录入，最高可信度 |
| manual | 0.9 | 手动录入，经过人工整理 |
| collected | 0.7 | 网页采集，需验证 |
| llm_generated | 0.6 | AI 生成，需验证 |
| user_feedback | 0.8 | 用户反馈补充 |
| imported | 0.7 | 外部导入 |

### 3.4 知识状态流转

```
┌─────────┐    验证通过    ┌─────────┐    反馈差    ┌───────────┐
│  DRAFT  │──────────────▶│ ACTIVE  │─────────────▶│ DEPRECATED│
└─────────┘               └─────────┘              └───────────┘
     │                          │                        │
     │                          │                        │
     │    自动生成              │    长期不用            │
     ▼                          ▼                        ▼
┌─────────┐               ┌─────────┐              ┌─────────┐
│ PENDING │               │ ARCHIVED│              │ ARCHIVED│
└─────────┘               └─────────┘              └─────────┘
```

## 四、版本控制

### 4.1 版本记录结构

```json
{
  "fish_species:青鱼": [
    {
      "version": 1,
      "data": { /* 完整知识数据 */ },
      "meta": { /* 元数据 */ },
      "changes": "初始版本",
      "changed_at": "2026-02-13T10:30:00",
      "changed_by": "system"
    },
    {
      "version": 2,
      "data": { /* 更新后的数据 */ },
      "meta": { /* 更新后的元数据 */ },
      "changes": "补充钓法技巧",
      "changed_at": "2026-02-13T14:20:00",
      "changed_by": "user"
    }
  ]
}
```

### 4.2 版本控制策略

1. **自动版本**：每次知识更新自动创建新版本
2. **变更记录**：记录变更说明和操作者
3. **版本回溯**：支持查看历史版本
4. **备份机制**：重要操作前自动备份

## 五、质量控制

### 5.1 质量评估维度

```
┌─────────────────────────────────────────────────────┐
│                  知识质量评估体系                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  来源可信度 ──────┐                                 │
│                   │                                 │
│  验证状态 ────────┼───▶ 综合置信度 ────▶ 质量等级   │
│                   │                                 │
│  用户反馈 ────────┘                                 │
│                                                     │
│  质量等级：                                         │
│  • A级：置信度 ≥ 0.9，已验证，反馈良好              │
│  • B级：置信度 ≥ 0.7，未验证或反馈一般              │
│  • C级：置信度 < 0.7 或反馈较差                     │
│  • D级：已废弃，待处理                              │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 5.2 反馈机制

**正面反馈影响**：
- 提升知识可信度
- 影响搜索排序权重

**负面反馈影响**：
- 降低知识置信度
- 触发质量预警
- 自动降级处理

**自动降级规则**：
```python
if positive_rate < 0.3 and total_feedback >= 5:
    status = "deprecated"  # 自动废弃
elif positive_rate < 0.5 and total_feedback >= 3:
    status = "pending"     # 待审核
```

## 六、检索系统

### 6.1 检索方式对比

| 方式 | 原理 | 优点 | 缺点 | 适用场景 |
|------|------|------|------|----------|
| 关键词 | 精确匹配 | 速度快、准确 | 无法理解语义 | 明确查询 |
| 语义 | 向量相似度 | 理解意图 | 需要模型 | 模糊查询 |
| 混合 | 综合评分 | 平衡效果 | 计算量大 | 通用场景 |

### 6.2 混合检索流程

```
用户查询
    │
    ▼
┌─────────────┐
│ 关键词检索   │───────┐
└─────────────┘       │
                      │
┌─────────────┐       ▼       ┌─────────────┐
│ 语义检索     │───▶ 分数融合 ───▶ 排序返回   │
└─────────────┘               └─────────────┘
```

### 6.3 向量模型

**默认模型**：`paraphrase-multilingual-MiniLM-L12-v2`

**选择理由**：
- 支持中文
- 模型较小（约 400MB）
- 效果良好

**安装依赖**：
```bash
pip install sentence-transformers
```

## 七、维护操作

### 7.1 日常维护命令

```bash
# 查看知识库统计
/stats

# 搜索知识
/search 青鱼

# 验证知识
/verify fish 青鱼

# 提交反馈
/feedback fish 青鱼 good

# 保存 AI 生成的知识
/save-knowledge fish 青鱼
```

### 7.2 数据备份

**自动备份**：
- 添加/更新知识时自动备份
- 备份文件命名：`fishing_knowledge.backup_YYYYMMDD_HHMMSS.json`

**手动备份**：
```python
from skills import KnowledgeManager
manager = KnowledgeManager()
manager.backup()
```

### 7.3 质量巡检

```python
from skills import KnowledgeManager

manager = KnowledgeManager()

# 获取低置信度知识
low_confidence = manager.get_low_confidence_knowledge(threshold=0.8)

# 获取统计信息
stats = manager.get_stats()
```

## 八、扩展指南

### 8.1 添加新知识类型

1. 在 `KnowledgeManager.TYPE_MAPPING` 添加映射
2. 在 `VectorStore._create_document_text` 添加文本生成逻辑
3. 更新 `KnowledgeGenerator` 的提示词模板

### 8.2 自定义置信度策略

```python
class KnowledgeManager:
    DEFAULT_CONFIDENCE = {
        "expert": 1.0,
        "manual": 0.9,
        "custom_source": 0.8,  # 添加自定义来源
    }
```

### 8.3 集成外部向量数据库

当前使用 JSON 文件存储向量，可扩展为：
- Milvus
- Pinecone
- Weaviate
- Chroma

## 九、最佳实践

### 9.1 知识录入

1. 优先使用专家录入或手动录入
2. AI 生成的知识必须经过验证
3. 网页采集的知识需要人工审核
4. 及时处理用户反馈

### 9.2 质量保障

1. 定期检查低置信度知识
2. 关注用户反馈趋势
3. 及时更新过时知识
4. 保持版本历史完整

### 9.3 性能优化

1. 定期重建向量索引
2. 清理废弃知识
3. 压缩版本历史
4. 合并重复知识

## 十、故障排查

### 10.1 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 向量搜索不可用 | 未安装依赖 | `pip install sentence-transformers` |
| 知识保存失败 | 文件权限 | 检查 data 目录权限 |
| 搜索结果不准确 | 索引过期 | 重建向量索引 |
| 反馈未生效 | 知识名称不匹配 | 使用正确的名称 |

### 10.2 日志调试

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

---

**文档版本**：1.0  
**更新日期**：2026-02-13  
**维护者**：路亚钓鱼宗师开发团队
